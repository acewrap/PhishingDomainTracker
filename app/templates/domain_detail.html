{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>{{ domain.domain_name }}</h2>
        <p class="text-muted">Entered on: {{ domain.date_entered.strftime('%Y-%m-%d %H:%M') }}</p>
        
        <div class="card mb-4">
            <div class="card-header">
                Details
                <form action="{{ url_for('enrich_domain_route', id=domain.id) }}" method="POST" class="float-end">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-sm btn-outline-primary">Enrich / Refresh</button>
                </form>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Registrar:</strong> {{ domain.registrar or 'Unknown' }}</p>
                        <p><strong>Status:</strong> {{ domain.registration_status or 'Unknown' }}</p>
                        <p><strong>IP Address:</strong> {{ domain.ip_address or 'Unknown' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Is Active:</strong> {{ domain.is_active }}</p>
                        <p><strong>Has Login Page:</strong> {{ domain.has_login_page }}</p>
                        <p><strong>Urlscan UUID:</strong> {{ domain.urlscan_uuid or 'None' }}</p>
                    </div>
                </div>
                
                {% if domain.screenshot_link %}
                    <div class="mt-3">
                        <strong>Screenshot / Report Link:</strong> <a href="{{ domain.screenshot_link }}" target="_blank">{{ domain.screenshot_link }}</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Infrastructure Correlations</div>
            <div class="card-body">
                {% if related_sites %}
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Domain</th>
                                <th>Confidence Score</th>
                                <th>Pivot Points</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in related_sites %}
                                <tr>
                                    <td><a href="{{ url_for('domain_details', id=item.domain.id) }}">{{ item.domain.domain_name }}</a></td>
                                    <td>
                                        {% if item.score >= 50 %}
                                            <span class="badge bg-danger">{{ item.score }}</span>
                                        {% elif item.score >= 30 %}
                                            <span class="badge bg-warning text-dark">{{ item.score }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ item.score }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <ul class="mb-0 ps-3">
                                            {% for pivot in item.pivots %}
                                                <li>{{ pivot }}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No correlations found.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">Manual Updates</div>
            <div class="card-body">
                <form action="{{ url_for('update_domain', id=domain.id) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="action_taken" class="form-label">Action Taken</label>
                        <textarea class="form-control" id="action_taken" name="action_taken" rows="3">{{ domain.action_taken or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="date_remediated" class="form-label">Date Remediated</label>
                        <input type="date" class="form-control" id="date_remediated" name="date_remediated" value="{{ domain.date_remediated.strftime('%Y-%m-%d') if domain.date_remediated else '' }}">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" {% if domain.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="is_active">Website Active?</label>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="has_login_page" name="has_login_page" {% if domain.has_login_page %}checked{% endif %}>
                        <label class="form-check-label" for="has_login_page">Has Login Page?</label>
                    </div>

                    <div class="mb-3">
                         <label for="manual_status" class="form-label">Manual Status Override</label>
                         <select class="form-select" id="manual_status" name="manual_status">
                            <option value="" {% if not domain.manual_status %}selected{% endif %}>None (Auto)</option>
                            <option value="Allowlisted" {% if domain.manual_status == 'Allowlisted' %}selected{% endif %}>Allowlisted (Green)</option>
                            <option value="Internal/Pentest" {% if domain.manual_status == 'Internal/Pentest' %}selected{% endif %}>Internal / Pentest (Blue)</option>
                            <option value="Confirmed Phish" {% if domain.manual_status == 'Confirmed Phish' %}selected{% endif %}>Confirmed Phish (Red)</option>
                            <option value="Takedown Requested" {% if domain.manual_status == 'Takedown Requested' %}selected{% endif %}>Takedown Requested (Purple)</option>
                         </select>
                    </div>

                    <button type="submit" class="btn btn-success">Update Record</button>
                </form>

                <hr>

                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#reportModal" {% if not can_report %}disabled{% endif %}>
                    Report to Security Vendors
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reportModalLabel">Confirm Reporting</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Please enter your password to confirm reporting this domain to security vendors (Google Web Risk, URLhaus, PhishTank).</p>
        <div class="mb-3">
            <label for="confirmPassword" class="form-label">Password</label>
            <input type="password" class="form-control" id="confirmPassword" required>
        </div>
        <div id="reportResult" class="mt-3"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitReport()">Report</button>
      </div>
    </div>
  </div>
</div>

<script>
function submitReport() {
    const password = document.getElementById('confirmPassword').value;
    const resultDiv = document.getElementById('reportResult');
    const csrfToken = "{{ csrf_token() }}";

    if (!password) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Password is required.</div>';
        return;
    }

    resultDiv.innerHTML = '<div class="alert alert-info">Reporting... Please wait.</div>';

    fetch("{{ url_for('report_phishing_route', id=domain.id) }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({ password: password })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '<div class="alert alert-success">Reporting Complete:<br><ul>';
            for (const [vendor, status] of Object.entries(data.results)) {
                html += `<li><strong>${vendor}:</strong> ${status}</li>`;
            }
            html += '</ul></div>';
            resultDiv.innerHTML = html;
        } else {
             resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `<div class="alert alert-danger">Request failed: ${error}</div>`;
    });
}
</script>
{% endblock %}
